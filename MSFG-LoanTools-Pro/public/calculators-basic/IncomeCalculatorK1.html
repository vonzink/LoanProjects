<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/master.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSFG • 1065 K-1 Income Calculator</title>

</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="https://msfg-media.s3.us-west-2.amazonaws.com/Assets/LOGOS/MSFG+Home+Loans/MSFG-Color-Transparent.png" alt="MSFG Logo">
        </div>
    </header>

    <main class="container">
        <section class="hero">
            <h2>1065 K-1 Income Calculator</h2>
            <p>Calculate monthly income from 1065 K-1 partnership distributions. Enter K-1 income and loss items with support for multiple partnerships.</p>
        </section>

        <div class="notes">
            <strong>Instructions:</strong> Use this calculator for K‑1s received from partnerships (Form 1065). For each K‑1 enter the ordinary income or loss, rental income or loss, 
            other net rental income or loss and guaranteed payments to partner. The calculator will compute a yearly total and derive a qualifying monthly income using the standard averaging rule. 
            If the second year shows a decline or is absent, only the most recent year will be used.
        </div>

        <div id="k1_sections">
            <!-- K-1 sections will be dynamically generated -->
        </div>

        <!-- Combined totals -->
        <section class="section">
            <h3>Combined K-1 Monthly Income <span class="status-badge">Live</span></h3>
            <div class="results-grid">
                <div class="result-item">
                    <h4>Total Monthly Income</h4>
                    <span id="combined_k1_1065" class="result">$0.00</span>
                </div>
            </div>
        </section>

        <div class="actions">
            <button class="btn" onclick="exportCSV()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export CSV
            </button>
            <button class="btn secondary" onclick="printView()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                </svg>
                Print View
            </button>
            <button class="btn secondary" onclick="clearAll()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Clear All
            </button>
        </div>

        <div class="footer">
            <strong>Calculation Policy:</strong> The total year income for each K‑1 is the sum of the four lines. If two years are provided and the most recent year exceeds the prior year, 
            the total of both years is divided by 24 months; otherwise only the most recent year is divided by 12. Combined monthly income sums the calculated income from all K‑1s.
        </div>
    </main>

    <script>
        const kCount = 4;
        const kContainer = document.getElementById('k1_sections');

        // Generate K-1 sections dynamically
        for (let i = 1; i <= kCount; i++) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `
                <h3>K‑1 #${i} <span class="status-badge">Live</span></h3>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Line #</th>
                            <th>Sign</th>
                            <th>Current Year</th>
                            <th>Prior Year (optional)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ordinary Business Income or Loss</td>
                            <td>1</td>
                            <td>+/–</td>
                            <td><input type="number" id="p${i}_ord1" value="0" onchange="calcP()" placeholder="0"></td>
                            <td><input type="number" id="p${i}_ord2" value="0" onchange="calcP()" placeholder="0"></td>
                        </tr>
                        <tr>
                            <td>Net Rental Income or Real Estate Loss</td>
                            <td>2/3</td>
                            <td>+/–</td>
                            <td><input type="number" id="p${i}_rent1" value="0" onchange="calcP()" placeholder="0"></td>
                            <td><input type="number" id="p${i}_rent2" value="0" onchange="calcP()" placeholder="0"></td>
                        </tr>
                        <tr>
                            <td>Other Net Rental Income or Loss</td>
                            <td>—</td>
                            <td>+/–</td>
                            <td><input type="number" id="p${i}_other1" value="0" onchange="calcP()" placeholder="0"></td>
                            <td><input type="number" id="p${i}_other2" value="0" onchange="calcP()" placeholder="0"></td>
                        </tr>
                        <tr>
                            <td>Guaranteed Payments to Partner</td>
                            <td>4</td>
                            <td>+</td>
                            <td><input type="number" id="p${i}_guar1" value="0" onchange="calcP()" placeholder="0"></td>
                            <td><input type="number" id="p${i}_guar2" value="0" onchange="calcP()" placeholder="0"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="results-grid">
                    <div class="result-item">
                        <h4>Total Current Year Income</h4>
                        <span id="p${i}_yr1" class="result">$0.00</span>
                    </div>
                    <div class="result-item">
                        <h4>Total Prior Year Income</h4>
                        <span id="p${i}_yr2" class="result">$0.00</span>
                    </div>
                    <div class="result-item">
                        <h4>Monthly Income (Policy)</h4>
                        <span id="p${i}_month" class="result">$0.00</span>
                    </div>
                </div>
            `;
            kContainer.appendChild(div);
        }

        function parseNum(v) {
            const n = parseFloat(v);
            return isNaN(n) ? 0 : n;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function computeP(prefix) {
            const ord1 = parseNum(document.getElementById(prefix + '_ord1').value);
            const ord2 = parseNum(document.getElementById(prefix + '_ord2').value);
            const rent1 = parseNum(document.getElementById(prefix + '_rent1').value);
            const rent2 = parseNum(document.getElementById(prefix + '_rent2').value);
            const other1 = parseNum(document.getElementById(prefix + '_other1').value);
            const other2 = parseNum(document.getElementById(prefix + '_other2').value);
            const guar1 = parseNum(document.getElementById(prefix + '_guar1').value);
            const guar2 = parseNum(document.getElementById(prefix + '_guar2').value);

            const year1 = ord1 + rent1 + other1 + guar1;
            const year2 = ord2 + rent2 + other2 + guar2;

            const year2Vals = [ord2, rent2, other2, guar2];
            const hasYr2 = year2Vals.some((v) => v !== 0);

            let monthly;
            if (hasYr2 && year1 > year2) {
                monthly = (year1 + year2) / 24;
            } else {
                monthly = year1 / 12;
            }

            return { year1, year2, monthly };
        }

        function calcP() {
            let combined = 0;
            for (let i = 1; i <= kCount; i++) {
                const res = computeP('p' + i);
                document.getElementById('p' + i + '_yr1').textContent = formatCurrency(res.year1);
                document.getElementById('p' + i + '_yr2').textContent = formatCurrency(res.year2);
                document.getElementById('p' + i + '_month').textContent = formatCurrency(res.monthly);
                combined += res.monthly;
            }
            document.getElementById('combined_k1_1065').textContent = formatCurrency(combined);
        }

        function exportCSV() {
            let combined = 0;
            const data = [
                ['1065 K-1 Income Calculator'],
                ['']
            ];

            for (let i = 1; i <= kCount; i++) {
                const res = computeP('p' + i);
                combined += res.monthly;

                data.push([`K-1 #${i}`, 'Line #', 'Sign', 'Current Year', 'Prior Year']);
                data.push(['Ordinary Business Income or Loss', '1', '+/–', parseNum(document.getElementById(`p${i}_ord1`).value), parseNum(document.getElementById(`p${i}_ord2`).value)]);
                data.push(['Net Rental Income or Real Estate Loss', '2/3', '+/–', parseNum(document.getElementById(`p${i}_rent1`).value), parseNum(document.getElementById(`p${i}_rent2`).value)]);
                data.push(['Other Net Rental Income or Loss', '—', '+/–', parseNum(document.getElementById(`p${i}_other1`).value), parseNum(document.getElementById(`p${i}_other2`).value)]);
                data.push(['Guaranteed Payments to Partner', '4', '+', parseNum(document.getElementById(`p${i}_guar1`).value), parseNum(document.getElementById(`p${i}_guar2`).value)]);
                data.push(['', '', '', '', '']);
                data.push(['Total Current Year Income', '', '', res.year1, '']);
                data.push(['Total Prior Year Income', '', '', res.year2, '']);
                data.push(['Monthly Income (Policy)', '', '', res.monthly, '']);
                data.push(['', '', '', '', '']);
            }

            data.push(['Results', 'Amount']);
            data.push(['Combined Monthly Income', combined]);

            const csvContent = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '1065_k1_income_calculator.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printView() {
            window.print();
        }

        function clearAll() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = '0';
            });
            calcP();
        }

        // Initialize
        calcP();

        // Expose debug function
        window.IncomeCalculatorK1 = {
            debug: function() {
                const results = {};
                let combined = 0;

                for (let i = 1; i <= kCount; i++) {
                    const res = computeP('p' + i);
                    combined += res.monthly;

                    results[`k1_${i}`] = {
                        inputs: {
                            year1: {
                                ordinary: parseNum(document.getElementById(`p${i}_ord1`).value),
                                rental: parseNum(document.getElementById(`p${i}_rent1`).value),
                                other: parseNum(document.getElementById(`p${i}_other1`).value),
                                guaranteed: parseNum(document.getElementById(`p${i}_guar1`).value)
                            },
                            year2: {
                                ordinary: parseNum(document.getElementById(`p${i}_ord2`).value),
                                rental: parseNum(document.getElementById(`p${i}_rent2`).value),
                                other: parseNum(document.getElementById(`p${i}_other2`).value),
                                guaranteed: parseNum(document.getElementById(`p${i}_guar2`).value)
                            }
                        },
                        calculations: {
                            totalYear1: res.year1,
                            totalYear2: res.year2,
                            monthlyIncome: res.monthly
                        }
                    };
                }

                return {
                    k1s: results,
                    combined: {
                        monthlyIncome: combined
                    },
                    version: '1.0.0'
                };
            }
        };
    </script>

    <!-- Theme Switcher -->
    <script src="theme-switcher.js"></script>

    <!-- ZZ Signature -->
    <div style="position: fixed; bottom: 20px; right: 20px; font-size: 12px; color: var(--text-muted); font-family: monospace; z-index: 1000;">
        ZZ
    </div>
</body>
</html>

