<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APR Calculator - MSFG Loan Tools Pro</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Calculate Annual Percentage Rate with detailed cost breakdown">
    <meta name="theme-color" content="#3b82f6">

    <!-- Master CSS -->
    <link rel="stylesheet" href="../css/master.css">

    <!-- Custom Styles -->

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <img src="../assets/icon.svg" alt="MSFG Logo">
            <div>
                <h2 style="margin: 0; color: var(--text-primary);">MSFG</h2>
                <p style="margin: 0; color: var(--text-secondary); font-size: var(--font-size-sm);">Loan Tools Pro</p>
            </div>
        </div>

        <nav class="nav">
            <a href="../index.html" class="nav-link">Home</a>
            <a href="#" class="nav-link active">APR Calculator</a>
        </nav>
    </header>

    <!-- Calculator Header -->
    <section class="calculator-header">
        <div class="container">
            <h1 class="calculator-title">APR Calculator</h1>
            <p class="calculator-subtitle">Calculate Annual Percentage Rate with detailed cost breakdown</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <!-- Input Form -->
            <div class="col">
                <!-- PDF Import Section -->
                <div class="form-section">
                    <h3 class="section-title">
                        ðŸ“„ PDF Import
                        <span class="feature-badge pdf-feature">Drag & Drop</span>
                    </h3>
                    <div class="pdf-drop-zone" id="pdfDropZone">
                        <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4);">ðŸ“„</div>
                        <h4>Import Loan Documents</h4>
                        <p class="text-secondary">Drop Loan Estimate or Closing Disclosure PDFs here to auto-fill the form</p>
                        <button class="btn btn-primary mt-4" onclick="selectPDFFile()">Browse Files</button>
                    </div>
                </div>

                <!-- Loan Information -->
                <div class="form-section">
                    <h3 class="section-title">ðŸ’° Loan Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="loanAmount">Loan Amount</label>
                            <input type="number" id="loanAmount" class="form-input" placeholder="300,000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="interestRate">Interest Rate (%)</label>
                            <input type="number" id="interestRate" class="form-input" placeholder="5.5" step="0.125" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="loanTerm">Loan Term (Years)</label>
                            <select id="loanTerm" class="form-select" required>
                                <option value="">Select Term</option>
                                <option value="15">15 Years</option>
                                <option value="20">20 Years</option>
                                <option value="30">30 Years</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="paymentType">Payment Type</label>
                            <select id="paymentType" class="form-select" required>
                                <option value="principal-interest">Principal & Interest</option>
                                <option value="interest-only">Interest Only</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Closing Costs -->
                <div class="form-section">
                    <h3 class="section-title">ðŸ’³ Closing Costs</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label" for="originationFee">Origination Fee</label>
                            <input type="number" id="originationFee" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="discountPoints">Discount Points</label>
                            <input type="number" id="discountPoints" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="appraisalFee">Appraisal Fee</label>
                            <input type="number" id="appraisalFee" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="titleInsurance">Title Insurance</label>
                            <input type="number" id="titleInsurance" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="escrowFees">Escrow Fees</label>
                            <input type="number" id="escrowFees" class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="otherFees">Other Fees</label>
                            <input type="number" id="otherFees" class="form-input" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-between items-center mb-6">
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button class="btn btn-primary" onclick="calculateAPR()">Calculate APR</button>
                </div>
            </div>

            <!-- Results -->
            <div class="col">
                <div class="results-section">
                    <h3 class="section-title">ðŸ“Š Results</h3>

                    <div id="resultsContent">
                        <div class="text-center text-secondary">
                            <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4);">ðŸ“ˆ</div>
                            <p>Enter loan information and click "Calculate APR" to see results</p>
                        </div>
                    </div>
                </div>

                <!-- Comparison Section -->
                <div class="results-section mt-6">
                    <h3 class="section-title">ðŸ”„ Loan Comparison</h3>
                    <div id="comparisonContent">
                        <p class="text-secondary">Compare multiple loan offers to find the best deal</p>
                        <button class="btn btn-secondary w-full mt-4" onclick="addComparison()">Add Loan for Comparison</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Scripts -->
    <script src="../js/pdf-parser.js"></script>
    <script src="../js/app.js"></script>

    <script>
        // Check for extracted PDF data on page load
        document.addEventListener('DOMContentLoaded', function() {
            const extractedData = sessionStorage.getItem('extractedPDFData');

            if (extractedData) {
                try {
                    const data = JSON.parse(extractedData);
                    console.log('Found extracted PDF data:', data);

                    if (data.formType === 'Loan Estimate' || data.formType === 'Closing Disclosure') {
                        // Populate APR calculator form fields
                        populateAPRForm(data.data);

                        // Clear the stored data
                        sessionStorage.removeItem('extractedPDFData');

                        // Show success message
                        showNotification('Loan data populated from PDF!', 'success');
                    }
                } catch (error) {
                    console.error('Error parsing extracted data:', error);
                }
            }
        });

        function populateAPRForm(data) {
            // Map extracted fields to form inputs
            const fieldMappings = {
                'loanAmount': 'loanAmount',
                'interestRate': 'interestRate',
                'loanTerm': 'loanTerm',
                'originationCharges': 'originationCharges',
                'appraisalFee': 'appraisalFee',
                'creditReport': 'creditReport',
                'titleInsurance': 'titleInsurance',
                'recordingFees': 'recordingFees',
                'transferTaxes': 'transferTaxes',
                'prepaidInterest': 'prepaidInterest',
                'propertyTaxes': 'propertyTaxes',
                'homeownersInsurance': 'homeownersInsurance'
            };

            // Populate form fields
            Object.entries(fieldMappings).forEach(([dataKey, formId]) => {
                const input = document.getElementById(formId);
                if (input && data[dataKey]) {
                    input.value = data[dataKey];
                    // Trigger change event to update calculations
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        }

        function showNotification(message, type = 'info') {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
            `;

            // Set background color based on type
            switch (type) {
                case 'success':
                    notification.style.background = '#10b981';
                    break;
                case 'error':
                    notification.style.background = '#ef4444';
                    break;
                case 'warning':
                    notification.style.background = '#f59e0b';
                    break;
                default:
                    notification.style.background = '#3b82f6';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
    </script>

    <script>
        // APR Calculator specific functionality
        function calculateAPR() {
            // Get form values
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 30;
            const paymentType = document.getElementById('paymentType').value;

            // Get closing costs
            const originationFee = parseFloat(document.getElementById('originationFee').value) || 0;
            const discountPoints = parseFloat(document.getElementById('discountPoints').value) || 0;
            const appraisalFee = parseFloat(document.getElementById('appraisalFee').value) || 0;
            const titleInsurance = parseFloat(document.getElementById('titleInsurance').value) || 0;
            const escrowFees = parseFloat(document.getElementById('escrowFees').value) || 0;
            const otherFees = parseFloat(document.getElementById('otherFees').value) || 0;

            // Calculate total closing costs
            const totalClosingCosts = originationFee + discountPoints + appraisalFee + titleInsurance + escrowFees + otherFees;

            // Calculate monthly payment
            const monthlyRate = interestRate / 100 / 12;
            const numberOfPayments = loanTerm * 12;
            let monthlyPayment;

            if (paymentType === 'interest-only') {
                monthlyPayment = (loanAmount * monthlyRate);
            } else {
                monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
                               (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
            }

            // Calculate APR (simplified)
            const totalPayments = monthlyPayment * numberOfPayments;
            const totalCost = totalPayments + totalClosingCosts;
            const effectiveRate = Math.pow(totalCost / loanAmount, 1 / numberOfPayments) - 1;
            const apr = effectiveRate * 12 * 100;

            // Display results
            displayResults({
                loanAmount: loanAmount,
                interestRate: interestRate,
                monthlyPayment: monthlyPayment,
                totalClosingCosts: totalClosingCosts,
                apr: apr,
                totalPayments: totalPayments,
                totalCost: totalCost
            });
        }

        function displayResults(results) {
            const resultsContent = document.getElementById('resultsContent');

            resultsContent.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Loan Amount</span>
                    <span class="result-value">$${results.loanAmount.toLocaleString()}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Interest Rate</span>
                    <span class="result-value">${results.interestRate.toFixed(3)}%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Monthly Payment</span>
                    <span class="result-value">$${results.monthlyPayment.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Total Closing Costs</span>
                    <span class="result-value">$${results.totalClosingCosts.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Total Payments</span>
                    <span class="result-value">$${results.totalPayments.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Total Cost</span>
                    <span class="result-value">$${results.totalCost.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">APR</span>
                    <span class="result-value">${results.apr.toFixed(3)}%</span>
                </div>
            `;
        }

        function clearForm() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.value = '';
            });

            document.getElementById('resultsContent').innerHTML = `
                <div class="text-center text-secondary">
                    <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-4);">ðŸ“ˆ</div>
                    <p>Enter loan information and click "Calculate APR" to see results</p>
                </div>
            `;
        }

        function selectPDFFile() {
            // This will be implemented with the PDF parser
            console.log('PDF file selection triggered');
        }

        function addComparison() {
            // This will be implemented for loan comparison
            console.log('Add comparison triggered');
        }

        // Initialize calculator
        document.addEventListener('DOMContentLoaded', function() {
            console.log('APR Calculator loaded');

            // Set default values
            document.getElementById('loanTerm').value = '30';
            document.getElementById('paymentType').value = 'principal-interest';
        });
    </script>
</body>
</html>
